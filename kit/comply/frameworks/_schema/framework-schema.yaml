# OpenSecKit V5 - Framework Definition Schema
# Purpose: JSON Schema for validating frameworks/<framework>/framework.yaml files

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://openseckit.dev/schemas/framework-v4.yaml"
title: "OpenSecKit Compliance Framework Definition"
description: "Schema for defining compliance frameworks (GDPR, RGS, ISO 27001, etc.)"

type: object
required:
  - metadata
  - categories
  - controls
  - scoring

properties:
  # ═══════════════════════════════════════════════════════════════════════════
  # METADATA
  # ═══════════════════════════════════════════════════════════════════════════
  metadata:
    type: object
    required:
      - framework_id
      - name
      - version
      - authority
    properties:
      framework_id:
        type: string
        pattern: "^[a-z][a-z0-9-]*$"
        description: "Unique lowercase identifier (e.g., 'rgpd', 'rgs', 'iso27001')"
        examples: ["rgpd", "rgs", "iso27001", "nis2", "soc2"]

      name:
        type: string
        minLength: 5
        description: "Full framework name"
        examples: ["Règlement Général sur la Protection des Données"]

      name_en:
        type: string
        description: "English name (if primary name is not English)"
        examples: ["General Data Protection Regulation"]

      version:
        type: string
        description: "Official version of the regulation/standard"
        examples: ["2016/679", "2.0", "2022"]

      authority:
        type: string
        description: "Issuing authority"
        examples: ["European Union", "ANSSI", "ISO/IEC"]

      effective_date:
        type: string
        format: date
        description: "When the framework came into effect"

      scope:
        type: string
        description: "What the framework covers"

      language:
        type: string
        pattern: "^[a-z]{2}$"
        default: "en"
        description: "Primary language (ISO 639-1)"

  # ═══════════════════════════════════════════════════════════════════════════
  # CATEGORIES
  # ═══════════════════════════════════════════════════════════════════════════
  categories:
    type: array
    minItems: 1
    description: "Groupings of controls (chapters, domains, annexes)"
    items:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          pattern: "^[a-z][a-z0-9_]*$"
          description: "Category identifier"
          examples: ["principles", "rights", "authentification"]

        name:
          type: string
          description: "Display name for the category"

        articles:
          type: array
          items:
            type: string
          description: "Article numbers (for regulations like GDPR)"
          examples: [["5", "6", "7", "8", "9", "10", "11"]]

        annexe:
          type: string
          description: "Annexe reference (for RGS cryptographic annexes)"
          examples: ["A1", "B1", "C"]

        domain:
          type: string
          description: "Functional domain (for RGS control categories)"
          examples: ["AUTH", "INT", "CONF"]

        clause:
          type: string
          description: "Clause reference (for ISO standards)"
          examples: ["A.5", "A.6"]

  # ═══════════════════════════════════════════════════════════════════════════
  # CONTROLS
  # ═══════════════════════════════════════════════════════════════════════════
  controls:
    type: array
    minItems: 1
    description: "Individual requirements/controls"
    items:
      type: object
      required:
        - id
        - name
        - description
        - category
        - criticality
        - evidence_types
      properties:
        id:
          type: string
          pattern: "^[A-Z]+-[A-Za-z0-9.-]+$"
          description: "Unique control ID, prefixed with framework ID"
          examples: ["RGPD-5.1.a", "RGS-AUTH.1", "ISO27001-A.5.1"]

        article:
          type: string
          description: "Article reference (GDPR)"
          examples: ["5.1.a", "28"]

        annexe:
          type: string
          description: "Annexe reference (RGS cryptographic annexes)"
          examples: ["A1", "B1", "C"]

        domain:
          type: string
          description: "Functional domain (RGS control categories)"
          examples: ["AUTH", "INT", "CONF", "TRAC", "HORO", "SIG"]

        clause:
          type: string
          description: "Clause reference (ISO)"
          examples: ["A.5.1", "A.8.24"]

        name:
          type: string
          description: "Short control name"
          examples: ["Lawfulness, fairness and transparency"]

        description:
          type: string
          description: "Full requirement text"

        category:
          type: string
          description: "Reference to categories[].id"

        criticality:
          type: string
          enum: ["must", "should", "may"]
          description: "Requirement strength (must=mandatory, should=recommended, may=optional)"

        evidence_types:
          type: array
          minItems: 1
          items:
            type: string
            enum:
              # Data evidence
              - processing_records
              - retention_policy
              - data_inventory
              - purpose_documentation
              - data_quality_procedures
              - deletion_procedures
              - necessity_assessment
              # Security evidence
              - security_measures
              - access_controls
              - encryption_evidence
              - auth_procedures
              - mfa_implementation
              - session_management
              - password_policy
              - tls_config
              - key_policy
              # Legal evidence
              - privacy_policy
              - privacy_notices
              - consent_mechanisms
              - consent_records
              - dpa_contracts
              - processor_register
              - legal_basis_documentation
              - legal_basis_register
              - sccs
              - bcrs
              - transfer_agreements
              # Operational evidence
              - log_samples
              - logging_policy
              - audit_trails
              - breach_procedures
              - notification_records
              - communication_procedures
              - response_records
              - rectification_procedures
              - export_capabilities
              - update_mechanisms
              # Design evidence
              - design_documentation
              - privacy_considerations
              - default_settings
              - configuration_evidence
              - dpia_documentation
              # Compliance evidence
              - compliance_documentation
              - sensitive_data_safeguards
              - legal_basis_special
              - notification_procedures
              - safeguard_documentation
              - transfer_mechanisms
          description: "Types of evidence needed to demonstrate compliance"

        applies_when:
          type: string
          description: "Conditional applicability expression"
          examples:
            - "consent_based"
            - "sensitive_data"
            - "international_transfer"
            - "high_risk_processing"
            - "privileged_access"

        # RGS-specific
        rgs_levels:
          type: array
          items:
            type: string
            enum: ["rgs-star", "rgs-star-star", "rgs-star-star-star"]
          description: "Which RGS levels this control applies to"

        eidas_level:
          type: string
          enum: ["low", "substantiel", "high"]
          description: "eIDAS assurance level"

  # ═══════════════════════════════════════════════════════════════════════════
  # SCORING
  # ═══════════════════════════════════════════════════════════════════════════
  scoring:
    type: object
    required:
      - method
      - thresholds
    properties:
      method:
        type: string
        enum: ["weighted", "binary"]
        description: "Scoring method"

      weights:
        type: object
        properties:
          must:
            type: number
            default: 3
          should:
            type: number
            default: 2
          may:
            type: number
            default: 1
        description: "Weights for criticality levels (only for weighted method)"

      thresholds:
        type: object
        required:
          - compliant
          - partial
        properties:
          compliant:
            type: number
            minimum: 0
            maximum: 100
            description: "Minimum score for compliant status"
          partial:
            type: number
            minimum: 0
            maximum: 100
            description: "Minimum score for partial compliance"
          non_compliant:
            type: number
            default: 0
            description: "Below this is non-compliant"
        description: "Score thresholds for status determination"

  # ═══════════════════════════════════════════════════════════════════════════
  # CROSS-FRAMEWORK MAPPING (optional)
  # ═══════════════════════════════════════════════════════════════════════════
  cross_framework_mapping:
    type: object
    additionalProperties:
      type: object
      additionalProperties:
        type: array
        items:
          type: string
    description: "Mapping to other frameworks for cross-compliance"
    examples:
      - iso27001:
          "RGPD-5.1.f": ["A.8.2", "A.8.3", "A.8.10"]
          "RGPD-32": ["A.8.2", "A.8.24"]

  # ═══════════════════════════════════════════════════════════════════════════
  # RGS-SPECIFIC SECTIONS (optional)
  # ═══════════════════════════════════════════════════════════════════════════
  security_levels:
    type: array
    description: "Security classification levels (RGS)"
    items:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        minimum_controls_percent:
          type: number
          minimum: 0
          maximum: 100

  dicp_model:
    type: array
    description: "DICP security model (RGS-specific)"
    items:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
        name:
          type: string
        scale:
          type: string
        description:
          type: string

  homologation_process:
    type: object
    description: "Certification process (RGS homologation)"
    properties:
      phases:
        type: array
        items:
          type: object
          properties:
            phase:
              type: number
            name:
              type: string
            activities:
              type: array
              items:
                type: string

# ═══════════════════════════════════════════════════════════════════════════
# VALIDATION RULES
# ═══════════════════════════════════════════════════════════════════════════

# Custom validation rules:
# 1. All controls[].category must reference a valid categories[].id
# 2. All controls[].id must start with uppercase version of metadata.framework_id
# 3. If scoring.method is "weighted", scoring.weights must be defined
# 4. At least one control must have criticality "must"
